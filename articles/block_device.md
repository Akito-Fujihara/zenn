---
title: "デバイスアクセス"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["linux", "deviceaccess"]
published: false
---

# 自己紹介
都内SaaS 企業でSRE エンジニア ２年目のFujihara Akitoです。
週一程度簡単なmemo書を残したいと思っています。

# デバイスアクセス
プロセスはデバイスに直接アクセスすることはせず、カーネルを通してアクセスします。
理由としては
- 複数プロセスが同時にデバイスにアクセスすることで不具合を起こしてしまう可能性がある
- 本来アクセスしてはいけないデータなどを破壊したりできる

カーネルがデバイスにアクセスする時には以下ので手順で実行します
- デバイスファイルという特殊なファイルを使用する
- ブロックデバイスのデバイス上に構築したファイルシステムを操作。

## デバイスファイル
デバイスファイルはデバイス毎に存在するもので、デバイスドライバにアクセスするためのインターフェイスとなるファイル
Linuxではプロセスがデバイスを操作すると、カーネルのデバイスドライバというソフトウェアが、ユーザの代わりにアクセスする
- ファイルの種類にはキャラクタデバイス & ブロックデバイスなどがある
- デバイスのメジャー番号, マイナー番号が同じ組み合わせであれば同じデバイスdに対応しておりそうでなければ別のデバイスである

### キャラクタデバイス
キャラクタデバイスとは、読み出しと書き込みはできるが、デバイス内でアクセスする場所を変更するシーク操作をすることはできません。
代表的なものには
- マウス
- キーボード
- 端末

### ブロックデバイス
ブロックデバイスはファイルの読み書き以外にもシークができます
代表的なデバイスには
- HDD
- SSD
などのストレージデバイスです

## デバイスドライバ
プロセスがデバイスファイルにアクセスした際に動作する、デバイスドライバというカーネル機能が存在している
実際に操作フロー
1. プロセスがデバイスファイルを介してデバイスの操作を依頼
2. CPUがカーネルモードに切り替わり、デバイスドライバがレジスタを介してデバイスに要求を伝える
3. デバイスが要求に応じた処理をする
4. デバイスドライバがデバイスの処理の結果を受け取る
5. CPUがユーザモードに切り替わり、プロセスがデバイスドライバの処理完了を検出して結果を受け取る

### メモリマップトI/O
現代的なデバイスは、メモリマップトI/Oを使用してデバイスのレジスタにアクセス
Linuxカーネルは自分自身のアドレス空間に物理メモリを全てマップ


